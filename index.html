<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Solitaire Revisi</title>
    <style>
        :root {
            --bg-color: #050505;
            --card-width: 13vw;
            --card-height: 19vw;
            --card-gap: 2vw;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-gold: #ffd700;
            --text-glow-blue: 0 0 5px #00f3ff, 0 0 10px #00f3ff;
            --text-glow-pink: 0 0 5px #ff00ff, 0 0 10px #ff00ff;
            --box-glow-blue: 0 0 5px #00f3ff, inset 0 0 10px rgba(0, 243, 255, 0.2);
            --box-glow-pink: 0 0 5px #ff00ff, inset 0 0 10px rgba(255, 0, 255, 0.2);
            --nav-height: 70px;
        }

        @media (min-width: 600px) {
            :root {
                --card-width: 80px;
                --card-height: 112px;
                --card-gap: 20px;
            }
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none; /* Mencegah scroll/zoom default browser */
        }

        #game-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--nav-height));
            padding: 10px;
            box-sizing: border-box;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            height: var(--card-height);
        }

        .stock-waste-area, .foundation-area {
            display: flex;
            gap: var(--card-gap);
        }

        .tableau-area {
            display: flex;
            justify-content: space-between;
            height: 100%;
            position: relative;
        }

        .pile {
            width: var(--card-width);
            height: var(--card-height);
            border: 1px solid #333;
            border-radius: 8px;
            position: relative;
        }

        .pile-placeholder {
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #333; font-size: 24px;
        }

        /* --- REVISI DESAIN KARTU --- */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            /* Latar belakang hitam pekat */
            background-color: #000; 
            border-radius: 8px;
            position: absolute;
            cursor: grab;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px; /* Padding lebih kecil */
            transition: transform 0.2s ease, box-shadow 0.2s;
            backface-visibility: hidden;
            z-index: 10;
        }

        .card:active {
            cursor: grabbing;
        }

        .card.dragging {
            z-index: 1000 !important;
            transform: scale(1.05);
            transition: none;
            pointer-events: none;
        }

        .card-back {
            background: repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px);
            border: 1px solid #444;
        }

        .card.black {
            border: 2px solid var(--neon-blue);
            box-shadow: var(--box-glow-blue);
            color: var(--neon-blue);
        }
        .card.black .suit-small, .card.black .value, .card.black .card-center {
            text-shadow: var(--text-glow-blue);
        }

        .card.red {
            border: 2px solid var(--neon-pink);
            box-shadow: var(--box-glow-pink);
            color: var(--neon-pink);
        }
        .card.red .suit-small, .card.red .value, .card.red .card-center {
            text-shadow: var(--text-glow-pink);
        }

        .card.joker {
            border: 2px solid var(--neon-gold);
            box-shadow: 0 0 10px var(--neon-gold), inset 0 0 10px var(--neon-gold);
            color: var(--neon-gold);
        }

        /* Layout Pojok Baru: Angka di samping Simbol */
        .card-corner {
            display: flex;
            align-items: center;
            line-height: 1;
            font-weight: bold;
        }
        .card-top-left {
            position: absolute;
            top: 5px;
            left: 5px;
        }
        .card-bottom-right {
            position: absolute;
            bottom: 5px;
            right: 5px;
            transform: rotate(180deg);
        }

        .card-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
        }

        .value { font-size: 1.1rem; margin-right: 2px; }
        .suit-small { font-size: 1.1rem; }

        @media (max-width: 600px) {
            .card-center { font-size: 1.5rem; }
            .value, .suit-small { font-size: 0.9rem; }
        }
        /* --- AKHIR REVISI DESAIN --- */

        #bottom-nav {
            height: var(--nav-height);
            background-color: #111;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed; bottom: 0; width: 100%; z-index: 2000;
        }
        .nav-btn {
            background: none; border: none; color: #888;
            display: flex; flex-direction: column; align-items: center;
            cursor: pointer; font-size: 0.8rem; transition: color 0.3s;
        }
        .nav-btn:hover, .nav-btn:active { color: white; }
        .nav-btn svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }

        #modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; z-index: 3000;
        }
        .modal {
            background: #111; border: 1px solid var(--neon-blue);
            padding: 20px; border-radius: 10px; text-align: center;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); max-width: 80%;
        }
        .btn-primary {
            background: transparent; border: 1px solid var(--neon-pink);
            color: var(--neon-pink); padding: 10px 20px; cursor: pointer;
            font-weight: bold; box-shadow: 0 0 5px var(--neon-pink);
        }

        .winner-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; background: rgba(0,0,0,0.9); z-index: 4000;
        }
        .winner-text {
            font-size: 3rem; color: var(--neon-gold);
            text-shadow: 0 0 10px var(--neon-gold), 0 0 20px var(--neon-pink);
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="top-row">
            <div class="stock-waste-area">
                <div id="stock" class="pile" onclick="drawCard()">
                    <div class="pile-placeholder">↺</div>
                </div>
                <div id="waste" class="pile"></div>
            </div>
            <div class="foundation-area">
                <div id="foundation-0" class="pile foundation" data-suit="H"></div>
                <div id="foundation-1" class="pile foundation" data-suit="D"></div>
                <div id="foundation-2" class="pile foundation" data-suit="C"></div>
                <div id="foundation-3" class="pile foundation" data-suit="S"></div>
            </div>
        </div>
        <div class="tableau-area">
            <div id="tableau-0" class="pile tableau"></div>
            <div id="tableau-1" class="pile tableau"></div>
            <div id="tableau-2" class="pile tableau"></div>
            <div id="tableau-3" class="pile tableau"></div>
            <div id="tableau-4" class="pile tableau"></div>
            <div id="tableau-5" class="pile tableau"></div>
            <div id="tableau-6" class="pile tableau"></div>
        </div>
    </div>

    <nav id="bottom-nav">
        <button class="nav-btn" onclick="showMenu()">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg> Menu
        </button>
        <button class="nav-btn" onclick="confirmNewGame()">
            <svg viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg> New Game
        </button>
        <button class="nav-btn" onclick="activateJoker()" id="btn-joker">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/></svg> Joker
        </button>
        <button class="nav-btn" onclick="undoMove()">
            <svg viewBox="0 0 24 24"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg> Undo
        </button>
    </nav>

    <div id="modal-overlay"><div class="modal" id="modal-content"></div></div>
    <div class="winner-screen" id="winner-screen">
        <div class="winner-text">YOU WIN!</div>
        <button class="btn-primary" style="margin-top:20px" onclick="initGame()">Main Lagi</button>
    </div>

<script>
const SUITS = ['H', 'D', 'C', 'S'];
const VALUES = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
const SYMBOLS = { 'H': '♥', 'D': '♦', 'C': '♣', 'S': '♠' };

let deck = [], piles = {}, history = [];
let draggedCards = null, dragOrigin = null;
let isDragging = false; // Flag untuk membedakan klik vs drag

window.onload = () => {
    initGame();
    // Gunakan pointer events untuk unified touch/mouse
    document.addEventListener('pointermove', onDragMove);
    document.addEventListener('pointerup', onDragEnd);
};

function initGame() {
    deck = createDeck(); shuffle(deck);
    piles = { stock: [], waste: [], foundations: [[],[],[],[]], tableau: [[],[],[],[],[],[],[]] };
    history = []; document.getElementById('winner-screen').style.display = 'none';
    dealCards(); renderBoard(); saveState();
}

function createDeck() {
    let newDeck = [];
    for (let s of SUITS) for (let v of VALUES)
        newDeck.push({ suit: s, value: v, color: (s==='H'||s==='D')?'red':'black', faceUp: false, id: Math.random().toString(36).substr(2, 9) });
    return newDeck;
}
function shuffle(a) { for (let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i], a[j]] = [a[j], a[i]]; } }
function dealCards() {
    let c=0; for(let i=0;i<7;i++) for(let j=0;j<=i;j++) { let card=deck[c++]; if(j===i) card.faceUp=true; piles.tableau[i].push(card); }
    while(c<deck.length) piles.stock.push(deck[c++]);
}

function renderBoard() {
    renderPile('stock', piles.stock, true); renderPile('waste', piles.waste);
    for(let i=0;i<4;i++) renderPile(`foundation-${i}`, piles.foundations[i]);
    for(let i=0;i<7;i++) renderPile(`tableau-${i}`, piles.tableau[i], false, true);
    checkWinCondition();
}

function renderPile(elId, cards, isStock=false, isTableau=false) {
    const el = document.getElementById(elId); el.innerHTML = '';
    if(cards.length===0) { el.innerHTML=`<div class="pile-placeholder">${isStock?'↺':''}</div>`; return; }
    if(isStock) { el.appendChild(createCardDiv(cards[cards.length-1], true)); return; }
    
    cards.forEach((card, i) => {
        if(!isTableau && i!==cards.length-1) return;
        let cardDiv = createCardDiv(card);
        if(isTableau) cardDiv.style.top = `${i * 25}px`; else cardDiv.style.top = '0px';
        
        if(card.faceUp) {
            // Pointerdown untuk memulai drag
            cardDiv.onpointerdown = (e) => onDragStart(e, card, elId);
            // Onclick untuk Auto-move (jika tidak jadi drag)
            cardDiv.onclick = (e) => {
                if(!isDragging) tryAutoMove(card, elId);
            };
        }
        el.appendChild(cardDiv);
    });
}

function createCardDiv(card, forceBack=false) {
    const div = document.createElement('div'); div.className = 'card';
    if(!card.faceUp || forceBack) div.classList.add('card-back');
    else {
        div.classList.add(card.isJoker?'joker':card.color);
        const s = card.isJoker?'★':SYMBOLS[card.suit], v = card.isJoker?'JOKER':card.value;
        // REVISI HTML STRUKTUR KARTU
        div.innerHTML = `
            <div class="card-corner card-top-left">
                <span class="value">${v}</span><span class="suit-small">${s}</span>
            </div>
            <div class="card-center">${s}</div>
            <div class="card-corner card-bottom-right">
                <span class="value">${v}</span><span class="suit-small">${s}</span>
            </div>
        `;
    }
    div.dataset.id = card.id; return div;
}

function getCardValue(v) { if(v==='A')return 1;if(v==='J')return 11;if(v==='Q')return 12;if(v==='K')return 13;if(v==='JOKER')return 99;return parseInt(v);}
function canPlaceOnFoundation(c, p) { if(c.isJoker)return false; if(p.length===0)return c.value==='A'; const top=p[p.length-1]; return top.suit===c.suit && getCardValue(c.value)===getCardValue(top.value)+1;}
function canPlaceOnTableau(c, p) { if(p.length===0)return c.value==='K'||c.isJoker; const top=p[p.length-1]; if(c.isJoker||top.isJoker)return true; return c.color!==top.color && getCardValue(c.value)===getCardValue(top.value)-1;}

// --- REVISI AUTO MOVE (Fitur ditambahkan) ---
function tryAutoMove(card, sourceId) {
    const sourcePile = getPileByElementId(sourceId);
    // Hanya izinkan auto-move untuk kartu paling atas di tumpukan
    if (sourcePile.indexOf(card) !== sourcePile.length - 1) return;

    // Coba ke Foundation dulu
    for(let i=0;i<4;i++) {
        if(canPlaceOnFoundation(card, piles.foundations[i])) {
            saveState(); moveCard(card, sourceId, `foundation-${i}`); return;
        }
    }
    // Coba ke Tableau lain (jika bukan dari waste dan bukan King ke tempat kosong yang tidak perlu)
    if (!sourceId.startsWith('foundation')) { // Jangan auto move dari foundation ke tableau
        for(let i=0;i<7;i++) {
            if(`tableau-${i}`===sourceId) continue;
            // Jangan pindahkan King ke slot kosong via auto move, biarkan manual
            if(piles.tableau[i].length === 0 && card.value === 'K') continue;

            if(canPlaceOnTableau(card, piles.tableau[i])) {
                saveState(); moveCard(card, sourceId, `tableau-${i}`); return;
            }
        }
    }
}

function moveCard(card, fromId, toId) {
    const sPile = getPileByElementId(fromId), dPile = getPileByElementId(toId);
    const idx = sPile.indexOf(card), cardsToMove = sPile.splice(idx);
    dPile.push(...cardsToMove);
    if(sPile.length>0 && fromId.includes('tableau')) sPile[sPile.length-1].faceUp=true;
    renderBoard();
}
function drawCard() {
    saveState();
    if(piles.stock.length===0) { piles.stock=piles.waste.reverse().map(c=>{c.faceUp=false;return c;}); piles.waste=[]; }
    else { const c=piles.stock.pop(); c.faceUp=true; piles.waste.push(c); }
    renderBoard();
}

// --- REVISI DRAG AND DROP (Menggunakan Pointer Events & Logika Klik) ---
function onDragStart(e, card, sourceId) {
    if(e.button !== 0 && e.type !== 'pointerdown') return;
    e.stopPropagation(); // Stop event biar gak trigger click di elemen bawahnya
    isDragging = false; // Reset flag

    const sourcePile = getPileByElementId(sourceId);
    const cardIndex = sourcePile.indexOf(card);
    if(!card.faceUp) return;

    draggedCards = { cards: sourcePile.slice(cardIndex), sourceId: sourceId, elements: [] };
    const container = document.getElementById(sourceId);
    draggedCards.cards.forEach(c => {
        const el = container.querySelector(`[data-id="${c.id}"]`);
        if(el) { el.classList.add('dragging'); draggedCards.elements.push(el); }
    });
    
    const rect = draggedCards.elements[0].getBoundingClientRect();
    dragOrigin = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    
    // Capture pointer agar event tetap jalan meski keluar dari elemen
    e.target.setPointerCapture(e.pointerId);
}

function onDragMove(e) {
    if(!draggedCards) return;
    // Jika pointer bergerak lebih dari 5px, anggap ini sebagai drag, bukan klik
    isDragging = true; 
    draggedCards.elements.forEach((el, i) => {
        el.style.position='fixed'; el.style.left=`${e.clientX-dragOrigin.x}px`; el.style.top=`${e.clientY-dragOrigin.y+(i*25)}px`;
    });
}

function onDragEnd(e) {
    if(!draggedCards) return;
    
    // Lepaskan pointer capture
    if(e.target.releasePointerCapture) e.target.releasePointerCapture(e.pointerId);

    // Sembunyikan sebentar untuk deteksi elemen di bawahnya
    draggedCards.elements.forEach(el => el.style.display='none');
    // Deteksi target drop dengan margin error yang lebih besar (menggunakan titik tengah kartu)
    const dropX = e.clientX; 
    const dropY = e.clientY;
    const elemBelow = document.elementFromPoint(dropX, dropY);
    draggedCards.elements.forEach(el => el.style.display='');

    const dropTarget = elemBelow ? elemBelow.closest('.pile') : null;
    let success = false;
    if(dropTarget) {
        const targetId=dropTarget.id, targetPile=getPileByElementId(targetId), leadingCard=draggedCards.cards[0];
        let valid=false;
        if(targetId.includes('foundation')) { if(draggedCards.cards.length===1 && canPlaceOnFoundation(leadingCard, targetPile)) valid=true; }
        else if(targetId.includes('tableau')) { if(canPlaceOnTableau(leadingCard, targetPile)) valid=true; }
        
        if(valid) { saveState(); moveCard(leadingCard, draggedCards.sourceId, targetId); success=true; }
    }
    if(!success) renderBoard(); // Revert jika gagal
    draggedCards = null;
}

function getPileByElementId(id) {
    if(id==='stock')return piles.stock; if(id==='waste')return piles.waste;
    if(id.startsWith('foundation')) return piles.foundations[parseInt(id.split('-')[1])];
    if(id.startsWith('tableau')) return piles.tableau[parseInt(id.split('-')[1])];
    return null;
}
function saveState() { history.push(JSON.stringify({stock:piles.stock, waste:piles.waste, foundations:piles.foundations, tableau:piles.tableau})); if(history.length>20)history.shift();}
function undoMove() { if(history.length===0)return; const s=JSON.parse(history.pop()); piles.stock=s.stock; piles.waste=s.waste; piles.foundations=s.foundations; piles.tableau=s.tableau; renderBoard();}
function activateJoker() { showModal(`<h2>Beli Joker?</h2><p>10 $TOKEN</p><button class="btn-primary" onclick="spawnJoker()">BELI</button><button class="btn-primary" style="border-color:#555; color:#888; margin-left:10px" onclick="closeModal()">BATAL</button>`); }
function spawnJoker() { closeModal(); const j={suit:'Joker', value:'JOKER', color:'gold', faceUp:true, id:'joker-'+Date.now(), isJoker:true}; saveState(); piles.waste.push(j); renderBoard();}
function showMenu() { showModal(`<h2>Menu</h2><p>Neon Solitaire v1.1</p><button class="btn-primary" onclick="closeModal()">Tutup</button>`); }
function confirmNewGame() { showModal(`<h2>Game Baru?</h2><button class="btn-primary" onclick="initGame();closeModal()">Ya</button><button class="btn-primary" style="border-color:#555; color:#888; margin-left:10px" onclick="closeModal()">Batal</button>`); }
function showModal(h) { document.getElementById('modal-content').innerHTML=h; document.getElementById('modal-overlay').style.display='flex'; }
function closeModal() { document.getElementById('modal-overlay').style.display='none'; }
function checkWinCondition() { let t=0; for(let i=0;i<4;i++) t+=piles.foundations[i].length; if(t===52) document.getElementById('winner-screen').style.display='flex'; }
</script>
</body>
</html>


